<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•/æ³¨å†Œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .container {
            background-color: white;
            padding: 2.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            position: relative;
            z-index: 2;
        }

        .form-title {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #2c3e50;
            font-size: 1.8rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #5f6368;
            font-size: 0.9rem;
        }

        input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #dadce0;
            border-radius: 5px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            width: 100%;
            padding: 0.8rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 1rem;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .toggle-link {
            text-align: center;
            margin-top: 1.2rem;
            color: #5f6368;
        }

        .toggle-btn {
            color: #3498db;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            padding: 0;
        }

        .toggle-btn:hover {
            text-decoration: underline;
        }

        .form-panel {
            display: none;
        }

        .form-panel.active {
            display: block;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.85rem;
            margin-top: 0.3rem;
            display: none;
        }

        /* éªŒè¯ä»£ç æ ·å¼ */
        .code-display {
            background-color: #f8f9fa;
            padding: 0.8rem;
            border-radius: 5px;
            font-family: Consolas, monospace;
            font-size: 1rem;
            letter-spacing: 2px;
            margin-bottom: 0.5rem;
            text-align: center;
            border: 1px solid #eee;
        }

        /* å¯†é’¥ç›¸å…³æ ·å¼ */
        .key-link {
            color: #3498db;
            text-decoration: none;
            display: inline-block;
            margin: 0.3rem 0 0.5rem;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .key-link:hover {
            text-decoration: underline;
        }

        .hint {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.3rem;
        }

        /* äººæœºéªŒè¯å¼¹çª—æ ·å¼ */
        #captcha-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }

        .progress-container {
            width: 100%;
            height: 4px;
            background: #eee;
            border-radius: 2px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            width: 0;
            height: 100%;
            background: #3498db;
            transition: width 2s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å½•é¢æ¿ -->
        <div id="login-panel" class="form-panel active">
            <h2 class="form-title">ç™»å½•</h2>
            <div class="input-group">
                <label for="login-username">ç”¨æˆ·å</label>
                <input type="text" id="login-username" required>
                <div class="error-message" id="login-user-error">ç”¨æˆ·åä¸èƒ½ä¸ºç©º</div>
            </div>
            <div class="input-group">
                <label for="login-password">å¯†ç </label>
                <input type="password" id="login-password" required>
                <div class="error-message" id="login-pwd-error">å¯†ç é•¿åº¦è‡³å°‘4ä½ï¼ˆæ”¯æŒå¤§å°å†™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰</div>
            </div>
            <div class="error-message" id="login-fail-error" style="margin-top: 1rem;">ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯</div>
            <button class="btn" id="login-btn">ç™»å½•</button>
            <p class="toggle-link">
                è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<button class="toggle-btn" id="show-register">ç«‹å³æ³¨å†Œ</button>
            </p>
        </div>

        <!-- æ³¨å†Œé¢æ¿ï¼ˆå«éªŒè¯æ¨¡å—ï¼‰ -->
        <div id="register-panel" class="form-panel">
            <h2 class="form-title">æ³¨å†Œ</h2>
            <div class="input-group">
                <label for="register-username">ç”¨æˆ·å</label>
                <input type="text" id="register-username" required placeholder="æ”¯æŒå¤§å°å†™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼Œè‡³å°‘1ä½">
                <div class="error-message" id="register-user-error">ç”¨æˆ·åæ ¼å¼é”™è¯¯ï¼ˆä»…æ”¯æŒå¤§å°å†™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰</div>
                <div class="error-message" id="register-user-exist-error">è¯¥ç”¨æˆ·åå·²è¢«æ³¨å†Œ</div>
            </div>

            <!-- éªŒè¯ä»£ç ï¼ˆå¯†ç ä¸Šæ–¹ï¼‰ -->
            <div class="input-group">
                <label>éªŒè¯ä»£ç ï¼ˆè¯·å‹¿ä¿®æ”¹ï¼‰</label>
                <div class="code-display" id="verify-code">-- è¾“å…¥ç”¨æˆ·ååç‚¹å‡»æ¡†å¤–ç”Ÿæˆ --</div>
                <div class="hint">ç”±ç³»ç»Ÿéšæœºç”Ÿæˆï¼Œä¸€ä¸ªç”¨æˆ·åä»…èƒ½è·å–ä¸€æ¬¡</div>
            </div>

            <!-- éªŒè¯å¯†é’¥ï¼ˆéªŒè¯ä»£ç ä¸‹æ–¹ã€å¯†ç ä¸Šæ–¹ï¼‰ -->
            <div class="input-group">
                <label for="verify-key">éªŒè¯å¯†é’¥</label>
                <input type="text" id="verify-key" required placeholder="ç‚¹å‡»ä¸‹æ–¹è·å–å¯†é’¥">
                <span class="key-link" id="get-key-link">ğŸ‘‰ ç«‹å³è·å–å¯†é’¥ï¼ˆå¿…è§¦å‘éªŒè¯ï¼‰</span>
                <div class="hint">å¯†é’¥å¿…é¡»å½“å¤©ä½¿ç”¨ï¼ˆæ¯æ—¥æ›´æ–°ï¼‰</div>
                <div class="error-message" id="key-error">å¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ</div>
            </div>

            <!-- å¯†ç å’Œç¡®è®¤å¯†ç  -->
            <div class="input-group">
                <label for="register-password">å¯†ç </label>
                <input type="password" id="register-password" required placeholder="æ”¯æŒå¤§å°å†™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼Œè‡³å°‘4ä½">
                <div class="error-message" id="register-pwd-error">å¯†ç æ ¼å¼é”™è¯¯ï¼ˆä»…æ”¯æŒå¤§å°å†™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼Œè‡³å°‘4ä½ï¼‰</div>
            </div>
            <div class="input-group">
                <label for="confirm-password">ç¡®è®¤å¯†ç </label>
                <input type="password" id="confirm-password" required>
                <div class="error-message" id="confirm-error">ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´</div>
            </div>

            <button class="btn" id="register-btn">æ³¨å†Œ</button>
            <p class="toggle-link">
                å·²æœ‰è´¦å·ï¼Ÿ<button class="toggle-btn" id="show-login">ç«‹å³ç™»å½•</button>
            </p>
        </div>
    </div>

    <!-- äººæœºéªŒè¯å¼¹çª— -->
    <div id="captcha-modal">
        <div class="modal-content">
            <h3 style="color: #2c3e50; margin-bottom: 20px;">éªŒè¯æ‚¨æ˜¯çœŸäºº</h3>
            <p>æ­£åœ¨è‡ªåŠ¨éªŒè¯èº«ä»½...</p>
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <p style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                éªŒè¯å®Œæˆåè‡ªåŠ¨å¡«å……å¯†é’¥
            </p>
        </div>
    </div>

    <script>
        // ä»æœ¬åœ°å­˜å‚¨è·å–ç”¨æˆ·æ•°æ®
        let users = JSON.parse(localStorage.getItem('registeredUsers')) || [];
        let currentVerifyCode = ''; // å­˜å‚¨å½“å‰éªŒè¯ä»£ç 

        // DOMå…ƒç´ è·å–
        const verifyCodeEl = document.getElementById('verify-code');
        const verifyKeyInput = document.getElementById('verify-key');
        const getKeyLink = document.getElementById('get-key-link');
        const captchaModal = document.getElementById('captcha-modal');
        const progressBar = document.getElementById('progress-bar');
        const regUsername = document.getElementById('register-username');
        const regPassword = document.getElementById('register-password');
        const confirmPassword = document.getElementById('confirm-password');
        const loginUsername = document.getElementById('login-username');
        const loginPassword = document.getElementById('login-password');

        // é¢æ¿åˆ‡æ¢é€»è¾‘
        const loginPanel = document.getElementById('login-panel');
        const registerPanel = document.getElementById('register-panel');
        document.getElementById('show-register').addEventListener('click', () => {
            loginPanel.classList.remove('active');
            registerPanel.classList.add('active');
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
        });
        document.getElementById('show-login').addEventListener('click', () => {
            registerPanel.classList.remove('active');
            loginPanel.classList.add('active');
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
        });

        // 1. ç”¨æˆ·åå¤±å»ç„¦ç‚¹ç”ŸæˆéªŒè¯ä»£ç ï¼ˆå…è®¸æ•°å­—ï¼‰
        regUsername.addEventListener('blur', () => {
            const username = regUsername.value.trim();
            if (!username) {
                verifyCodeEl.textContent = '-- è¾“å…¥ç”¨æˆ·ååç‚¹å‡»æ¡†å¤–ç”Ÿæˆ --';
                currentVerifyCode = '';
                return;
            }

            // éªŒè¯ç”¨æˆ·åæ ¼å¼ï¼šæ”¯æŒå¤§å°å†™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼ˆæ–°å¢æ•°å­—æ”¯æŒï¼‰
            const usernameRegex = /^[A-Za-z0-9_]+$/;
            if (!usernameRegex.test(username)) {
                document.getElementById('register-user-error').style.display = 'block';
                verifyCodeEl.textContent = '-- ç”¨æˆ·åæ ¼å¼é”™è¯¯ --';
                currentVerifyCode = '';
                return;
            }

            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
            if (users.some(user => user.username === username)) {
                document.getElementById('register-user-exist-error').style.display = 'block';
                verifyCodeEl.textContent = '-- ç”¨æˆ·åå·²å­˜åœ¨ --';
                currentVerifyCode = '';
                return;
            }

            // ç”Ÿæˆ8ä½éªŒè¯ä»£ç 
            currentVerifyCode = generateVerifyCode();
            verifyCodeEl.textContent = currentVerifyCode;
            document.getElementById('register-user-error').style.display = 'none';
            document.getElementById('register-user-exist-error').style.display = 'none';
        });

        // 2. ç”Ÿæˆ8ä½éšæœºéªŒè¯ä»£ç 
        function generateVerifyCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            return code;
        }

        // 3. ç”Ÿæˆå¯†é’¥ï¼ˆæŒ‰è§„åˆ™è®¡ç®—ï¼‰
        function generateKey(code) {
            // æ‹¼æ¥ASCIIç 
            let asciiStr = '';
            for (let char of code) {
                asciiStr += char.charCodeAt(0).toString();
            }
            // æ‹¼æ¥å½“å¤©æ—¥æœŸï¼ˆå¹´+æœˆ+æ—¥ï¼‰
            const today = new Date();
            const year = today.getFullYear().toString();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            const dateStr = year + month + day;
            // è½¬16è¿›åˆ¶å–å‰16ä½
            const combined = BigInt(asciiStr) * BigInt(10 ** dateStr.length) + BigInt(dateStr);
            let hex = combined.toString(16).toUpperCase();
            hex = hex.padStart(16, '0').substring(0, 16);
            return hex;
        }

        // 4. ç‚¹å‡»è·å–å¯†é’¥è§¦å‘äººæœºéªŒè¯ï¼ˆ100%è§¦å‘ï¼‰
        getKeyLink.addEventListener('click', () => {
            const username = regUsername.value.trim();
            if (!username) {
                alert('è¯·å…ˆè¾“å…¥ç”¨æˆ·åï¼');
                regUsername.focus();
                return;
            }
            if (!currentVerifyCode) {
                alert('è¯·å…ˆè¾“å…¥ç”¨æˆ·åå¹¶ç‚¹å‡»è¾“å…¥æ¡†å¤–ç”ŸæˆéªŒè¯ä»£ç ï¼');
                return;
            }

            // æ˜¾ç¤ºå¼¹çª—å¹¶å¯åŠ¨è¿›åº¦æ¡
            captchaModal.style.display = 'flex';
            progressBar.style.width = '0';

            // æ¨¡æ‹ŸéªŒè¯è¿‡ç¨‹ï¼ˆ2ç§’åå®Œæˆï¼‰
            setTimeout(() => {
                progressBar.style.width = '100%';
                setTimeout(() => {
                    const key = generateKey(currentVerifyCode);
                    verifyKeyInput.value = key; // è‡ªåŠ¨å¡«å……å¯†é’¥
                    captchaModal.style.display = 'none'; // å…³é—­å¼¹çª—
                }, 800);
            }, 300);
        });

        // 5. æ³¨å†Œé€»è¾‘ï¼ˆç”¨æˆ·åå…è®¸æ•°å­—ï¼‰
        document.getElementById('register-btn').addEventListener('click', () => {
            // éšè—æ‰€æœ‰é”™è¯¯æç¤º
            document.querySelectorAll('#register-panel .error-message').forEach(el => el.style.display = 'none');
            let isValid = true;
            const username = regUsername.value.trim();
            const password = regPassword.value;
            const confirmPwd = confirmPassword.value;
            const inputKey = verifyKeyInput.value.trim();

            // éªŒè¯ç”¨æˆ·åï¼ˆå…è®¸æ•°å­—ï¼‰
            if (!/^[A-Za-z0-9_]+$/.test(username) || !username) {
                document.getElementById('register-user-error').style.display = 'block';
                isValid = false;
            } else if (users.some(user => user.username === username)) {
                document.getElementById('register-user-exist-error').style.display = 'block';
                isValid = false;
            }

            // éªŒè¯å¯†é’¥
            const correctKey = generateKey(currentVerifyCode);
            if (!inputKey || inputKey !== correctKey) {
                document.getElementById('key-error').style.display = 'block';
                isValid = false;
            }

            // éªŒè¯å¯†ç ï¼ˆå…è®¸æ•°å­—ï¼‰
            if (!/^[A-Za-z0-9_]+$/.test(password) || password.length < 4) {
                document.getElementById('register-pwd-error').style.display = 'block';
                isValid = false;
            }

            // éªŒè¯ç¡®è®¤å¯†ç 
            if (password !== confirmPwd) {
                document.getElementById('confirm-error').style.display = 'block';
                isValid = false;
            }

            // æ³¨å†ŒæˆåŠŸå¤„ç†
            if (isValid) {
                users.push({
                    username,
                    password,
                    key: inputKey
                });
                localStorage.setItem('registeredUsers', JSON.stringify(users));
                alert('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');
                
                // åˆ‡æ¢åˆ°ç™»å½•é¢æ¿å¹¶æ¸…ç©ºæ³¨å†Œè¡¨å•
                registerPanel.classList.remove('active');
                loginPanel.classList.add('active');
                regUsername.value = '';
                verifyCodeEl.textContent = '-- è¾“å…¥ç”¨æˆ·ååç‚¹å‡»æ¡†å¤–ç”Ÿæˆ --';
                verifyKeyInput.value = '';
                regPassword.value = '';
                confirmPassword.value = '';
                currentVerifyCode = '';
            }
        });

        // 6. ç™»å½•é€»è¾‘
        document.getElementById('login-btn').addEventListener('click', () => {
            // éšè—æ‰€æœ‰é”™è¯¯æç¤º
            document.querySelectorAll('#login-panel .error-message').forEach(el => el.style.display = 'none');
            let isValid = true;
            const username = loginUsername.value.trim();
            const password = loginPassword.value;

            // éªŒè¯ç”¨æˆ·å
            if (!username) {
                document.getElementById('login-user-error').style.display = 'block';
                isValid = false;
            }

            // éªŒè¯å¯†ç 
            if (password.length < 4) {
                document.getElementById('login-pwd-error').style.display = 'block';
                isValid = false;
            }

            // éªŒè¯è´¦å·å¯†ç æ˜¯å¦åŒ¹é…
            if (isValid) {
                const user = users.find(u => u.username === username && u.password === password);
                if (user) {
                    // ç™»å½•æˆåŠŸï¼Œå­˜å‚¨å½“å‰ç”¨æˆ·å¹¶è·³è½¬ä¸»é¡µ
                    localStorage.setItem('currentUser', username);
                    window.location.href = 'home.html';
                } else {
                    document.getElementById('login-fail-error').style.display = 'block';
                }
            }
        });
    </script>
</body>
</html>
