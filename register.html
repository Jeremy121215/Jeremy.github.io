<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="logo.png" type="image/png" sizes="32x32">
    <title>æ³¨å†Œ - æ˜Ÿæ²³ä¸ºæ¢¦çš„ç½‘é¡µ</title>
    <style>
        body {
            font-family: "å¾®è½¯é›…é»‘", Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
            position: relative;
            z-index: 1;
        }
        .back-link {
            display: inline-block;
            margin: 10px 0 25px;
            color: #3498db;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .register-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 2;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }
        .hint {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }
        .error {
            color: #e74c3c;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }
        .code-display {
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            font-family: Consolas, monospace;
            font-size: 1.1rem;
            letter-spacing: 2px;
            margin-bottom: 10px;
            text-align: center;
            border: 1px solid #eee;
        }
        .btn {
            width: 100%;
            padding: 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .key-link {
            color: #3498db;
            text-decoration: none;
            display: inline-block;
            margin: 5px 0 15px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            padding: 5px 0;
        }
        .key-link:hover {
            text-decoration: underline;
            color: #2980b9;
        }
        /* å¼¹çª—å¼ºåˆ¶æ˜¾ç¤ºæ ·å¼ï¼Œæ— ä»»ä½•éšè—bug */
        #captcha-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            /* å¼ºåˆ¶æ˜¾ç¤ºï¼Œé¿å…è¢«é®æŒ¡ */
            opacity: 1 !important;
            visibility: visible !important;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-title {
            text-align: center;
            color: #2c3e50;
            margin: 0 0 20px;
            font-size: 1.2rem;
        }
        .progress-container {
            width: 100%;
            height: 4px;
            background: #eee;
            border-radius: 2px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress-bar {
            width: 0;
            height: 100%;
            background: #3498db;
            transition: width 2s ease-in-out;
        }
    </style>
</head>
<body>
    <a href="home.html" class="back-link">â† è¿”å›ä¸»é¡µ</a>
    
    <div class="register-container">
        <h1>ç”¨æˆ·æ³¨å†Œ</h1>
        <form id="register-form">
            <!-- 1. ç”¨æˆ·å -->
            <div class="form-group">
                <label for="username">ç”¨æˆ·å</label>
                <input type="text" id="username" required placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆå¤§å°å†™å­—æ¯/ä¸‹åˆ’çº¿ï¼‰">
                <div class="hint">åªèƒ½åŒ…å«å¤§å°å†™å­—æ¯ã€ä¸‹åˆ’çº¿ï¼Œè‡³å°‘1ä½</div>
                <div class="error" id="username-error">ç”¨æˆ·åæ ¼å¼é”™è¯¯æˆ–å·²å­˜åœ¨</div>
            </div>

            <!-- 2. éªŒè¯ä»£ç ï¼ˆå¯†ç ä¸Šæ–¹ï¼Œä»…æ³¨å†Œé¡µæœ‰ï¼‰ -->
            <div class="form-group">
                <label>éªŒè¯ä»£ç ï¼ˆè¯·å‹¿ä¿®æ”¹ï¼‰</label>
                <div class="code-display" id="verify-code">-- è¾“å…¥ç”¨æˆ·ååè‡ªåŠ¨ç”Ÿæˆ --</div>
                <div class="hint">ç”±ç³»ç»Ÿéšæœºç”Ÿæˆï¼Œä¸€ä¸ªç”¨æˆ·åä»…èƒ½è·å–ä¸€æ¬¡</div>
            </div>

            <!-- 3. éªŒè¯å¯†é’¥ï¼ˆéªŒè¯ä»£ç ä¸‹æ–¹ã€å¯†ç ä¸Šæ–¹ï¼Œä»…æ³¨å†Œé¡µæœ‰ï¼‰ -->
            <div class="form-group">
                <label for="verify-key">éªŒè¯å¯†é’¥</label>
                <input type="text" id="verify-key" placeholder="ç‚¹å‡»ä¸‹æ–¹è·å–å¯†é’¥" required>
                <span class="key-link" id="get-key-link">ğŸ‘‰ ç«‹å³è·å–å¯†é’¥ï¼ˆå¿…è§¦å‘éªŒè¯ï¼‰</span>
                <div class="hint">å¯†é’¥å¿…é¡»å½“å¤©ä½¿ç”¨ï¼ˆæ¯æ—¥æ›´æ–°ï¼‰</div>
                <div class="error" id="key-error">å¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ</div>
            </div>

            <!-- 4. å¯†ç  -->
            <div class="form-group">
                <label for="password">å¯†ç </label>
                <input type="password" id="password" required placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘4ä½ï¼Œå¤§å°å†™å­—æ¯/ä¸‹åˆ’çº¿ï¼‰">
                <div class="hint">åªèƒ½åŒ…å«å¤§å°å†™å­—æ¯ã€ä¸‹åˆ’çº¿ï¼Œè‡³å°‘4ä½</div>
                <div class="error" id="password-error">å¯†ç æ ¼å¼é”™è¯¯</div>
            </div>

            <!-- 5. ç¡®è®¤å¯†ç  -->
            <div class="form-group">
                <label for="confirm-password">ç¡®è®¤å¯†ç </label>
                <input type="password" id="confirm-password" required placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                <div class="error" id="confirm-error">ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´</div>
            </div>

            <!-- æ³¨å†ŒæŒ‰é’® -->
            <button type="submit" class="btn">æ³¨å†Œ</button>
        </form>
    </div>

    <!-- äººæœºéªŒè¯å¼¹çª—ï¼ˆ100%è§¦å‘ï¼Œæ— ä»»ä½•éšè—é€»è¾‘ï¼‰ -->
    <div id="captcha-modal">
        <div class="modal-content">
            <h3 class="modal-title">éªŒè¯æ‚¨æ˜¯çœŸäºº</h3>
            <div style="text-align: center;">
                <p>æ­£åœ¨è‡ªåŠ¨éªŒè¯èº«ä»½...</p>
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <p style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                    éªŒè¯å®Œæˆåè‡ªåŠ¨å¡«å……å¯†é’¥ï¼ˆæ— éœ€æ‰‹åŠ¨æ“ä½œï¼‰
                </p>
            </div>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒDOMå…ƒç´ ï¼ˆç¡®ä¿è·å–100%æˆåŠŸï¼‰
        const usernameInput = document.getElementById('username');
        const verifyCodeEl = document.getElementById('verify-code');
        const verifyKeyInput = document.getElementById('verify-key');
        const getKeyLink = document.getElementById('get-key-link');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const captchaModal = document.getElementById('captcha-modal');
        const progressBar = document.getElementById('progress-bar');

        // é”™è¯¯æç¤ºå…ƒç´ 
        const errors = {
            username: document.getElementById('username-error'),
            key: document.getElementById('key-error'),
            password: document.getElementById('password-error'),
            confirm: document.getElementById('confirm-error')
        };

        let currentVerifyCode = ''; // å­˜å‚¨å½“å‰éªŒè¯ä»£ç 

        // 1. ç”¨æˆ·åå¤±å»ç„¦ç‚¹ â†’ å¼ºåˆ¶ç”ŸæˆéªŒè¯ä»£ç ï¼ˆæ— ä»»ä½•è·³è¿‡é€»è¾‘ï¼‰
        usernameInput.addEventListener('blur', () => {
            const username = usernameInput.value.trim();
            if (!username) {
                verifyCodeEl.textContent = '-- è¾“å…¥ç”¨æˆ·ååè‡ªåŠ¨ç”Ÿæˆ --';
                currentVerifyCode = '';
                return;
            }

            // éªŒè¯ç”¨æˆ·åæ ¼å¼
            const usernameRegex = /^[A-Za-z_]+$/;
            if (!usernameRegex.test(username)) {
                errors.username.style.display = 'block';
                verifyCodeEl.textContent = '-- ç”¨æˆ·åæ ¼å¼é”™è¯¯ --';
                currentVerifyCode = '';
                return;
            }

            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
            const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const isExists = users.some(u => u.username === username);
            if (isExists) {
                errors.username.style.display = 'block';
                verifyCodeEl.textContent = '-- ç”¨æˆ·åå·²å­˜åœ¨ --';
                currentVerifyCode = '';
                return;
            }

            // å¼ºåˆ¶ç”Ÿæˆ8ä½éªŒè¯ä»£ç ï¼ˆå¤§å°å†™å­—æ¯+æ•°å­—ï¼Œæ— éšæœºå¤±è´¥ï¼‰
            currentVerifyCode = generateVerifyCode();
            verifyCodeEl.textContent = currentVerifyCode;
            errors.username.style.display = 'none';
        });

        // 2. ç”Ÿæˆ8ä½éšæœºéªŒè¯ä»£ç ï¼ˆ100%ç”ŸæˆæˆåŠŸï¼‰
        function generateVerifyCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let code = '';
            // å¼ºåˆ¶å¾ªç¯8æ¬¡ï¼Œç¡®ä¿ä»£ç é•¿åº¦æ­£ç¡®
            for (let i = 0; i < 8; i++) {
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            return code;
        }

        // 3. ç”Ÿæˆå¯†é’¥ï¼ˆä¸¥æ ¼æŒ‰è§„åˆ™ï¼Œæ— æº¢å‡ºï¼‰
        function generateKey(code) {
            // æ­¥éª¤1ï¼šæ‹¼æ¥æ¯ä¸ªå­—ç¬¦çš„ASCIIç ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰
            let asciiStr = '';
            for (let char of code) {
                asciiStr += char.charCodeAt(0).toString();
            }
            // æ­¥éª¤2ï¼šæ‹¼æ¥å½“å¤©æ—¥æœŸï¼ˆå¹´+æœˆ+æ—¥ï¼Œè¡¥é›¶ç¡®ä¿æ ¼å¼æ­£ç¡®ï¼‰
            const today = new Date();
            const year = today.getFullYear().toString();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            const dateStr = year + month + day;
            // æ­¥éª¤3ï¼šBigInté¿å…æº¢å‡º â†’ è½¬16è¿›åˆ¶ â†’ å¼ºåˆ¶å–å‰16ä½ï¼ˆä¸è¶³è¡¥é›¶ï¼‰
            const combined = BigInt(asciiStr) * BigInt(10 ** dateStr.length) + BigInt(dateStr);
            let hex = combined.toString(16).toUpperCase();
            hex = hex.padStart(16, '0').substring(0, 16);
            return hex;
        }

        // 4. ç‚¹å‡»ã€Œè·å–å¯†é’¥ã€â†’ 100%è§¦å‘å¼¹çª—ï¼ˆæ— ä»»ä½•æ¡ä»¶åˆ¤æ–­ï¼Œä»…åŸºç¡€æ ¡éªŒï¼‰
        getKeyLink.addEventListener('click', () => {
            // ä»…ä¸¤ä¸ªåŸºç¡€æ ¡éªŒï¼Œæ— å…¶ä»–æ‹¦æˆª
            if (!usernameInput.value.trim()) {
                alert('è¯·å…ˆè¾“å…¥ç”¨æˆ·åï¼');
                usernameInput.focus();
                return;
            }
            if (!currentVerifyCode) {
                alert('è¯·å…ˆè¾“å…¥ç”¨æˆ·åå¹¶ç‚¹å‡»è¾“å…¥æ¡†å¤–ç”ŸæˆéªŒè¯ä»£ç ï¼');
                return;
            }

            // å¼ºåˆ¶æ˜¾ç¤ºå¼¹çª—ï¼ˆç›´æ¥èµ‹å€¼displayï¼Œæ— éšè—é€»è¾‘ï¼‰
            captchaModal.style.display = 'flex';
            progressBar.style.width = '0'; // é‡ç½®è¿›åº¦æ¡

            // æ¨¡æ‹ŸéªŒè¯è¿‡ç¨‹ï¼ˆ2ç§’åå¿…å®Œæˆï¼Œæ— å¤±è´¥é€»è¾‘ï¼‰
            setTimeout(() => {
                progressBar.style.width = '100%'; // è¿›åº¦æ¡å¼ºåˆ¶æ»¡æ ¼
                // éªŒè¯å®Œæˆ â†’ å¼ºåˆ¶ç”Ÿæˆå¯†é’¥å¹¶å¡«å……
                setTimeout(() => {
                    const key = generateKey(currentVerifyCode);
                    verifyKeyInput.value = key; // å¼ºåˆ¶å¡«å……å¯†é’¥
                    captchaModal.style.display = 'none'; // å…³é—­å¼¹çª—
                }, 800);
            }, 300);
        });

        // 5. è¡¨å•æäº¤éªŒè¯ï¼ˆç¡®ä¿æ³¨å†Œæµç¨‹æ­£å¸¸ï¼‰
        document.getElementById('register-form').addEventListener('submit', (e) => {
            e.preventDefault();
            let isValid = true;

            // ç”¨æˆ·åéªŒè¯
            const username = usernameInput.value.trim();
            if (!/^[A-Za-z_]+$/.test(username) || !username) {
                errors.username.style.display = 'block';
                isValid = false;
            } else {
                errors.username.style.display = 'none';
            }

            // å¯†é’¥éªŒè¯ï¼ˆå¼ºåˆ¶åŒ¹é…ç”Ÿæˆè§„åˆ™ï¼‰
            const inputKey = verifyKeyInput.value.trim();
            const correctKey = generateKey(currentVerifyCode);
            if (!inputKey || inputKey !== correctKey) {
                errors.key.style.display = 'block';
                isValid = false;
            } else {
                errors.key.style.display = 'none';
            }

            // å¯†ç éªŒè¯
            if (!/^[A-Za-z_]+$/.test(passwordInput.value) || passwordInput.value.length < 4) {
                errors.password.style.display = 'block';
                isValid = false;
            } else {
                errors.password.style.display = 'none';
            }

            // ç¡®è®¤å¯†ç éªŒè¯
            if (passwordInput.value !== confirmPasswordInput.value) {
                errors.confirm.style.display = 'block';
                isValid = false;
            } else {
                errors.confirm.style.display = 'none';
            }

            // æ³¨å†ŒæˆåŠŸ â†’ ä¿å­˜ç”¨æˆ·å¹¶è·³è½¬
            if (isValid) {
                const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
                users.push({
                    username,
                    password: passwordInput.value,
                    key: inputKey
                });
                localStorage.setItem('registeredUsers', JSON.stringify(users));
                alert('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>
